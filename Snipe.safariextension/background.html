<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Snipe</title>
    <script src="string_score/string_score.js" type="text/javascript"></script>
</head>
<body>
    <script>
        safari.application.addEventListener("message", function(e) {
            switch (e.name) {
                case 'getTabData':
                    e.target.page.dispatchMessage("getTabData", getTabData());
                break;
                case 'getTabResults':
                    e.target.page.dispatchMessage("getTabResults", getTabResults(e.message, getTabData()));
                break;
                case 'selectTab':
                    safari.application.activeBrowserWindow.tabs[e.message].activate();
                break;
            }
        }, false);
        
        function getTabData() {
            var data = [],
                tabs = safari.application.activeBrowserWindow.tabs,
                tab;
            
            for (var i = 0, length = tabs.length; i < length; i++) {
                tab = tabs[i];
                data.push({
                    title: tab.title,
                    url: tab.url,
                    index: i,
                    score: 0
                });
            }
            
            return data;
        }
        
        function getTabResults(keyword, tabData) {
            var words = keyword.split(' '),
                results = [],
                score;
            
            for (var i = 0, length = tabData.length; i < length; i++) {
                score = tabData[i].title ? tabData[i].title.score(keyword) : 0;

                if (score > 0) {
                    tabData[i].score = score;
                    results.push(tabData[i]);
                }
            }
            
            function sortDescending(a, b) {
                return b.score - a.score;
            }
            
            function sortAscending(a, b) {
                return a.score - b.score;
            }
            
            return results.sort(sortDescending);
        }
    </script>
</body>
</html>
