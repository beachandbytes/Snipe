<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Snipe</title>
    <script src="string_score/string_score.js" type="text/javascript"></script>
</head>
<body>
    <script>
        var results;
        
        chrome.omnibox.onInputChanged.addListener(function(text, suggest) {
            getTabData(function(tabData) {
                //Save results
                results = getTabResults(text, tabData);
                
                //Update results list in omnibar
                suggest(results);
                
                //Update default suggestion to be top result
                chrome.omnibox.setDefaultSuggestion({
                    description: results[0].content
                });
            });
        });
        
        chrome.omnibox.onInputEntered.addListener(function(text) {
            var tab_id;
            
            //Get tab id of first result
            if (text.indexOf(':') < 0) {
                tab_id = parseInt(results[0].content.split(':')[0]);
            }
            //Get tab id of submitted result
            else {
                tab_id = parseInt(text.split(':')[0]);
            }
            
            chrome.tabs.update(tab_id, {selected: true});
        });
        
        function getTabData(callback) {
            var data = [];
            
            chrome.tabs.getAllInWindow(null, function(tabs) {
                var tab;

                for (var i = 0, length = tabs.length; i < length; i++) {
                    tab = tabs[i];
                    data.push({
                        title: tab.title,
                        url: tab.url,
                        index: tab.id,
                        score: 0,
                        
                        content: tab.id + ': ' + tab.title,
                        description: tab.title + ' <url>'+tab.url+'</url>'
                    });
                }
                
                callback(data);
            });
        }
        
        function getTabResults(keyword, tabData) {
            var results = [],
                score;
            
            for (var i = 0, length = tabData.length; i < length; i++) {
                score = tabData[i].title ? tabData[i].title.score(keyword) : 0;
                if (score > 0) {
                    tabData[i].score = score;
                    
                    // tabData[i].description = tabData[i].description.split(keyword).join('<match>' + keyword + '</match>');
                    var regexp = new RegExp(keyword, 'i'),
                        match = regexp.exec(tabData[i].description);
                        
                    if (match) {
                        //Surround exact keyword and regex match w/ the <match> tags to highlight the results
                        tabData[i].description = tabData[i].description.split(keyword).join('<match>' + keyword + '</match>').split(match[0]).join('<match>' + match[0] + '</match>');
                    }
                    
                    results.push(tabData[i]);
                }
            }
            
            function sortDescending(a, b) {
                return b.score - a.score;
            }
            
            function sortAscending(a, b) {
                return a.score - b.score;
            }
            
            return results.sort(sortDescending);
        }
    </script>
</body>
</html>
